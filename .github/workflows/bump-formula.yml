name: Open Homebrew PR

on:
  repository_dispatch:
    types:
      - stable-release

jobs:

  bump-stable:

    name: Bump stable formula
    runs-on: ubuntu-20.04

    steps:

      - name: Dump GitHub context
        run: echo "$GITHUB_CONTEXT"
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch public release
        id: release
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/cachewerk/relay-public-dummy/releases/tags/{tag_name}
          tag_name: ${{ github.event.client_payload.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GH }}

      - name: Download release assets
        env:
          RELEASE: ${{ steps.release.outputs.data }}
        run: |
          while IFS= read -r asset; do
            curl -sS --fail -o $(echo $asset | jq -r '.name') \
              --location $(echo $asset | jq -r '.url') \
              --header "Accept: application/octet-stream" \
              --header "Authorization: Bearer ${{ secrets.TOKEN_GH }}"
          done < <(echo $RELEASE | jq -c '.assets[] | select(.name | contains("darwin"))')
          ls -R

      - name: Update formula
        env:
          RELEASE: ${{ steps.release.outputs.data }}
        run: |
          for f in *.tar.gz; do
            HASH=$(sha256sum $f | head -c 64)
            MARKER=$(echo $f | cut -d - -f 3- | sed 's/.tar.gz//')
            URL=$(echo $RELEASE | jq -r ".assets[] | select(.name==\"$f\") | .browser_download_url")
            sed -i "/.*# stable: $MARKER/!b;n;c\ \ \ \ \ \ \ \ \ \ url \"$URL\"" Formula/relay.rb
            sed -i "/.*# stable: $MARKER/!b;n;n;c\ \ \ \ \ \ \ \ \ \ sha256 \"$HASH\"" Formula/relay.rb
          done

      - name: Commit changes
        env:
          TAG_NAME: ${{ github.event.client_payload.tag }}
        run: |
          git add Formula/relay.rb
          git commit -m "Bump stable to $TAG_NAME" --author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          git push -u origin pr/stable-$TAG_NAME
